<form id="codeForm">
  {% csrf_token %}
  <input type="hidden" id="problem_id" value="{{ submission.problem.id }}">

  <div class="mb-3">
    <label for="language" class="form-label">Language</label>
    <select id="language" name="language" class="form-select">
      <option value="python" {% if submission.language == "python" %}selected{% endif %}>Python</option>
      <option value="cpp" {% if submission.language == "cpp" %}selected{% endif %}>C++</option>
      <option value="java" {% if submission.language == "java" %}selected{% endif %}>Java</option>
      <option value="c" {% if submission.language == "c" %}selected{% endif %}>C</option>
      <option value="javascript" {% if submission.language == "javascript" %}selected{% endif %}>JavaScript</option>
    </select>
  </div>

  <div class="mb-3">
    <label for="source_code" class="form-label">Code</label>
    <textarea id="source_code" name="source_code" rows="15" class="form-control">{{ submission.code }}</textarea>
  </div>

  <button type="button" class="btn btn-primary" onclick="runCode()">Run Code</button>
  <button type="button" class="btn btn-success" onclick="submitCode()">Submit</button>
</form>

<div id="result" class="mt-4"></div>

<script>
  function runCode() {
    sendCode("{% url 'compile_code' %}");
  }

  function submitCode() {
    sendCode("{% url 'submit_code' %}");
  }

  function sendCode(url) {
    const sourceCode = document.getElementById("source_code").value;
    const language = document.getElementById("language").value;
    const problemId = document.getElementById("problem_id").value;

    fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({
        source_code: sourceCode,
        language: language,
        problem_id: problemId
      })
    })
    .then(response => response.json())
    .then(data => {
      let resultDiv = document.getElementById("result");
      if (data.verdict) {
        let outputHtml = `<div class="alert alert-info"><strong>Verdict:</strong> ${data.verdict}</div>`;
        
        if (data.results) {
          data.results.forEach((res, i) => {
            outputHtml += `
              <div class="card mb-3">
                <div class="card-body">
                  <h6>Test Case ${i + 1}</h6>
                  <p><strong>Input:</strong></p>
                  <pre class="bg-light p-2 border rounded">${res.input.trim()}</pre>
                  
                  <p><strong>Expected Output:</strong></p>
                  <pre class="bg-light p-2 border rounded">${res.expected_output.trim()}</pre>
                  
                  <p><strong>Actual Output:</strong></p>
                  <pre class="bg-light p-2 border rounded">${res.actual_output ? res.actual_output.trim() : "No Output"}</pre>
                  
                  ${res.compile_output ? `
                    <p class="text-warning"><strong>Compilation Error:</strong></p>
                    <pre class="bg-light p-2 border rounded">${res.compile_output.trim()}</pre>` : ""}
                  
                  ${res.stderr ? `
                    <p class="text-danger"><strong>Runtime Error:</strong></p>
                    <pre class="bg-light p-2 border rounded">${res.stderr.trim()}</pre>` : ""}
                  
                  <p><strong>Status:</strong> 
                    ${res.status === "Passed" 
                      ? `<span class="badge bg-success">Passed</span>` 
                      : `<span class="badge bg-danger">${res.status}</span>`}
                  </p>
                </div>
              </div>`;
          });
        }
        resultDiv.innerHTML = outputHtml;
      } else {
        resultDiv.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${data.error}</div>`;
      }
    });
  }
</script>
